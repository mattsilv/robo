---
title: "feat: MCP Device-Scoped Auth — Zero-Input Authentication"
type: feat
status: active
date: 2026-02-14
deadline: 2026-02-16 3:00 PM EST
estimated_time: 30 minutes
---

# MCP Device-Scoped Auth — Zero-Input Authentication

## Concept

The phone IS the passkey. No username, no password, no email, no biometrics. When a device registers, the backend auto-generates a secret `mcp_token`. The iOS app stores it and embeds it in the Claude Code connection command. The user just copies one command — auth is invisible.

## Current State

- Device registration: `POST /api/devices/register` → returns `{ id, name, registered_at }`
- MCP endpoint: `POST /mcp` → **currently unauthenticated**, sees ALL devices' data
- iOS stores `DeviceConfig { id, name, apiBaseURL }` in UserDefaults

## Target State

- Device registration returns an additional `mcp_token` field
- iOS stores the token in `DeviceConfig`
- MCP endpoint validates `Authorization: Bearer <mcp_token>` header
- MCP tools are **scoped to that device only** (only see your captures)
- iOS shows a "Connect to Claude Code" UI with the full command pre-built

## Implementation Steps

### Step 1: D1 Migration — Add `mcp_token` column

**New file:** `workers/migrations/0003_mcp_token.sql`

```sql
ALTER TABLE devices ADD COLUMN mcp_token TEXT;
```

Run: `cd workers && wrangler d1 migrations apply robo-db`

Then backfill existing devices (optional, for testing):
```sql
UPDATE devices SET mcp_token = hex(randomblob(16)) WHERE mcp_token IS NULL;
```

### Step 2: Backend — Generate token on registration

**File:** `workers/src/routes/devices.ts`

In `registerDevice`, after generating `deviceId`, also generate `mcp_token`:

```typescript
const mcpToken = [...crypto.getRandomValues(new Uint8Array(24))]
  .map(b => b.toString(16).padStart(2, '0')).join('');
```

Insert it into D1:
```typescript
await c.env.DB.prepare(
  'INSERT INTO devices (id, name, mcp_token, registered_at) VALUES (?, ?, ?, ?)'
).bind(deviceId, name, mcpToken, now).run();
```

Return it in the response:
```typescript
return c.json({ id: deviceId, name, mcp_token: mcpToken, registered_at: now }, 201);
```

### Step 3: Backend — Validate token on MCP requests

**File:** `workers/src/mcp.ts`

In `handleMcpRequest`, extract and validate the Bearer token:

```typescript
export async function handleMcpRequest(request: Request, env: Env): Promise<Response> {
  // Extract bearer token
  const authHeader = request.headers.get('Authorization');
  const token = authHeader?.startsWith('Bearer ') ? authHeader.slice(7) : null;

  if (!token) {
    return new Response(JSON.stringify({
      jsonrpc: '2.0',
      error: { code: -32000, message: 'Missing Authorization header. Use: claude mcp add robo --transport http URL --header "Authorization: Bearer YOUR_TOKEN"' },
      id: null,
    }), { status: 401, headers: { 'Content-Type': 'application/json' } });
  }

  // Look up device by token
  const device = await env.DB.prepare(
    'SELECT id, name FROM devices WHERE mcp_token = ?'
  ).bind(token).first<{ id: string; name: string }>();

  if (!device) {
    return new Response(JSON.stringify({
      jsonrpc: '2.0',
      error: { code: -32000, message: 'Invalid token' },
      id: null,
    }), { status: 401, headers: { 'Content-Type': 'application/json' } });
  }

  // Pass device context to MCP server
  const server = createRoboMcpServer(env, device.id);
  // ... rest of handler
}
```

### Step 4: Backend — Scope MCP tools to device

**File:** `workers/src/mcp.ts`

Change `createRoboMcpServer(env)` → `createRoboMcpServer(env, deviceId)`.

Then scope every query. For example `list_captures`:

```typescript
// Before (sees ALL devices):
'SELECT ... FROM sensor_data WHERE 1=1'

// After (scoped to authenticated device):
'SELECT ... FROM sensor_data WHERE device_id = ?'
// Always bind deviceId — remove device_id as a user-facing parameter
```

For `list_devices` — either remove this tool (not needed when scoped) or return only the authenticated device's info.

For `list_debug_payloads` — always use `debug/${deviceId}/` prefix.

### Step 5: iOS — Store `mcp_token` in DeviceConfig

**File:** `ios/Robo/Models/DeviceConfig.swift`

Add the token field:

```swift
struct DeviceConfig: Codable {
    var id: String
    var name: String
    var apiBaseURL: String
    var mcpToken: String?  // NEW — auto-generated by backend
    // ...
}
```

**File:** `ios/Robo/Services/APIService.swift`

Update `RegisterResponse` and `registerDevice()` to decode `mcp_token`:

```swift
private struct RegisterResponse: Decodable {
    let id: String
    let name: String
    let mcpToken: String?

    enum CodingKeys: String, CodingKey {
        case id, name
        case mcpToken = "mcp_token"
    }
}

func registerDevice(name: String) async throws -> DeviceConfig {
    // ...existing code...
    return DeviceConfig(
        id: response.id,
        name: response.name,
        apiBaseURL: baseURL,
        mcpToken: response.mcpToken  // NEW
    )
}
```

### Step 6: iOS — "Connect to Claude Code" UI

**File:** `ios/Robo/Views/ClaudeCodeConnectionView.swift` (new, ~50 lines)

Simple view shown in the Claude Code agent detail or after a capture:

```swift
struct ClaudeCodeConnectionView: View {
    let mcpToken: String

    private var connectionCommand: String {
        "claude mcp add robo --transport http https://robo-api.silv.workers.dev/mcp -H \"Authorization: Bearer \(mcpToken)\""
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            Label("Connect to Claude Code", systemImage: "terminal")
                .font(.headline)

            Text("Paste this in your terminal:")
                .font(.subheadline)
                .foregroundStyle(.secondary)

            Text(connectionCommand)
                .font(.system(.caption, design: .monospaced))
                .padding(8)
                .background(.quaternary)
                .cornerRadius(8)

            Button {
                UIPasteboard.general.string = connectionCommand
            } label: {
                Label("Copy Command", systemImage: "doc.on.doc")
            }
            .buttonStyle(.borderedProminent)
        }
        .padding()
    }
}
```

Wire this into the agent detail view or show it as a sheet after captures when the active agent is Claude Code.

## Key Files Reference

| File | Current State | What Changes |
|------|--------------|--------------|
| `workers/migrations/0003_mcp_token.sql` | Does not exist | **Create** — ALTER TABLE |
| `workers/src/routes/devices.ts` | Generates UUID only | Add `mcp_token` generation + return |
| `workers/src/mcp.ts` | No auth, sees all data | Add Bearer validation + device scoping |
| `workers/src/index.ts` | Routes /mcp to handler | No change needed |
| `ios/Robo/Models/DeviceConfig.swift` | `{ id, name, apiBaseURL }` | Add `mcpToken: String?` |
| `ios/Robo/Services/APIService.swift` | Decodes `{ id, name }` | Decode `mcp_token` too |
| `ios/Robo/Views/ClaudeCodeConnectionView.swift` | Does not exist | **Create** — copy command UI |

## Existing Device Handling

Existing devices won't have tokens. Two options:
- **(A) Backfill migration:** `UPDATE devices SET mcp_token = hex(randomblob(16)) WHERE mcp_token IS NULL;` — run this in the migration or manually
- **(B) Lazy generation:** When a device with no token calls any API, generate one and return it. More complex, skip for hackathon.

**Recommend (A)** — just backfill in the migration SQL.

## Worktree

Work is on `feat/claude-code-mcp-bridge` branch in worktree at:
```
/Users/m/gh/hackathon-cc-2026/robo-mcp-bridge
```

3 commits already on this branch:
```
e1972cd fix(ios): hide API URL from production users
fa2dd5e feat(ios): add Claude Code agent to agent list
1d91ec1 feat(workers): add MCP server for Claude Code sensor data bridge
```

## Testing Checklist

- [x] `wrangler d1 migrations apply robo-db` runs successfully
- [x] New device registration returns `mcp_token` in response
- [x] `curl -X POST /mcp` without token returns 401
- [x] `curl -X POST /mcp -H "Authorization: Bearer <valid_token>"` works
- [x] `list_captures` only returns the authenticated device's data
- [x] `list_debug_payloads` only returns the authenticated device's R2 payloads
- [x] iOS app stores `mcpToken` after registration
- [x] ClaudeCodeConnectionView shows the full command with token
- [x] Copy button works
- [x] `claude mcp add robo --transport http URL -H "Authorization: Bearer TOKEN"` connects
- [x] Existing REST endpoints unaffected (they use `X-Device-ID`, not Bearer)
